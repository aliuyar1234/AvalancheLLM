# PROGRESS

Pack version: 1.0.4 (see `spec/00_CANONICAL.md`).
Date: 2026-01-29.

This file is a handoff log. After reading it, you should be able to run the full pipeline in a clean workspace, regenerate all paper artifacts, refresh the user-provided LaTeX bundle, and produce a review ZIP.

## Where the LaTeX is (user-provided)
The LaTeX bundle you provided (with GPT Pro help) is in:
- `paper/latex/`

Key files:
- `paper/latex/main.tex` (entrypoint for Overleaf)
- `paper/latex/main.pdf` (compiled PDF in the LaTeX workspace; regenerated via `pdflatex`)
- `paper.pdf` (current compiled PDF snapshot for GitHub sharing)
- `paper_overleaf.zip` (Overleaf-ready zip; source bundle for editing/polish)
- `paper/latex/figures/` (copies of exported figure PDFs/PNGs)
- `paper/latex/tables/` (CSV/Parquet copies and generated LaTeX table snippets)

Note: `paper/latex/` is not automatically regenerated by the SSOT pipeline. Phase 7 updates the Markdown paper under `paper/*.md`. After new runs, you must re-sync figures/tables into `paper/latex/` and update `paper/latex/main.tex` if you want the LaTeX paper to reflect the newest outputs (including new appendix artifacts).

## What was accomplished today
Implementation and SSOT were updated to cover the full “make it reviewer-proof” list:

Core capability upgrades:
- Added multi-model replication support via `--model_role {INSTRUCT,BASE}` and ensured the run id / config hash changes when model role changes.
- Wired model selection through phases and analysis so artifacts record the correct `model_role` and `model_id` provenance.
- Updated the runbook tasks to execute both INSTRUCT and BASE variants for producing phases (1 through 6), enabling cross-model replication artifacts in Phase 7.

Nulls and controls:
- Added a stronger “structure-preserving” null: within-layer circular time shift (preserves per-layer token marginals exactly, preserves autocorrelation better than full permutation).
- Phase 4 now generates permutation null, circular-shift null, and token-shuffle-input null.
- Added tests for marginals preservation under null generation.

Statistical rigor:
- Phase 5 now computes bootstrap confidence intervals for mechanistic metrics (branching, delta-b, susceptibility chi) and exports them to tables and figures.
- Figures now support asymmetric CI error bars.

Crackling and tail-fit appendix:
- Added crackling fit diagnostics and a fail-closed quality gate (Phase 5 aborts if diagnostics fail).
- Added descriptive tail-fit comparison outputs with a fail-closed minimum tail sample gate.

Ablations:
- Added gain-target and layer-band interventions to support ablations (MLP global gain, ATTN global gain, and MLP banded gain: early/mid/late layers), with rate matching.
- Phase 5 exports an ablation appendix table and figure comparing interventions.

SSOT expansion:
- Added new canonical appendix artifacts in SSOT: figures F09–F11 and tables T04–T07.
- Updated `spec/18_RESULTS_TABLE_SKELETONS.md`, `spec/19_FIGURES_TABLES_PLAN.md`, and `spec/13_PIPELINE_STAGE_SPEC.md` to require the new appendix outputs (and required new T01 columns).

Tooling:
- Added `tools/run_paperready.ps1` to run the SSOT pipeline in a separate output root (clean repo), optionally in the background, and optionally sampling GPU usage via nvidia-smi.

Smoke verification (no long runs yet):
- `pytest` passes.
- `nvidia-smi` confirms the RTX PRO 6000 is visible.

## Current state
- No new long runs were executed after the 1.0.4 SSOT changes (by request). The existing `runs/` directory may contain older runs that do not include the new appendix artifacts. Do not delete old runs; new runs must be created.
- The next step is to generate fresh runs in a clean workspace so Phase 7 can assemble a paper snapshot that references the new outputs.

## Next session: generate the full data and review ZIP (long run)
Goal: produce fresh runs for INSTRUCT and BASE, including new appendix artifacts and replication summary, and produce a release ZIP for external review.

Recommended approach: run in a clean external workspace directory (keeps this repo clean, and avoids run ambiguity).

1) Start the pipeline in a new workspace (background)
- Run: `.\tools\run_paperready.ps1 -OutRoot D:\Research\avalanche_runs -MaxPhase 8 -GpuSmi -Background`

What it does:
- Copies this repo into a new timestamped workspace under `D:\Research\avalanche_runs\`.
- Executes commands in `tasks/TASK_INDEX.md` order using `CANON.CLI.CMD.*` references.
- Prints GPU usage samples if `-GpuSmi` is set.
- Writes logs to `D:\Research\avalanche_runs\paperready_YYYYMMDD_HHMMSS.log`.

2) Monitor progress
- Check the log file under `D:\Research\avalanche_runs\`.
- Inside the created workspace, new runs will appear under `runs/` as each producing command completes.

3) What must exist when it finishes (high-level)
- Phase 5 producing runs (for each model role) include:
  - `results/metrics.parquet` and `results/avalanches.parquet`
  - `tables/table_T01_SUMMARY.(csv|parquet)` with the new CI and shift-null columns
  - appendix tables T04–T06 under `tables/appendix/`
  - main figures F01–F05 and F08 plus appendix figures F09–F11 under `figs/` and `figs/appendix/`
- Phase 6 producing runs (for each model role) include:
  - Dataset B: T02 and F06
  - ARC: T03 and F07
- Phase 7 produces updated `paper/*.md` and writes T07 replication summary when both model roles are available.
- Phase 8 produces a new release ZIP and a matching `MANIFEST.sha256` in the workspace root, and records both in its run_record artifact_index.

4) If the pipeline fails (common gates)
- Crackling diagnostics gate fails:
  - Increase sample size by raising `CANON.CONST.N_WINDOWS_A_RASTERS` (and rerun in a fresh workspace).
  - If you change any SSOT constants, edit only `spec/00_CANONICAL.md` and rerun end-to-end.
- Tail-fit gate fails due to insufficient tail samples:
  - Increase sample size, or lower `CANON.CONST.TAIL_FIT_MIN_TAIL_SAMPLES` in `spec/00_CANONICAL.md`.
- Replication summary errors due to multiple matches:
  - Run only inside a fresh workspace with an empty `runs/` directory, or pass explicit `--dep` run ids when invoking Phase 7 manually.

## After the long run: refresh the LaTeX bundle for Overleaf
Once the new workspace run completes successfully:
- Copy the newest paper-facing figures (including appendix F09-F11) from the producing run directories into `paper/latex/figures/`.
- Copy the newest tables (including appendix T04-T07) into `paper/latex/tables/` and update any `tab_*.tex` snippets if needed.
- Update `paper/latex/main.tex` to include the new appendix artifacts if the LaTeX paper should show them.
- Rebuild the Overleaf ZIP from `paper/latex/` (this workspace emits `paper_overleaf.zip` in the repo root).

## Deliverable for GPT Pro review
- For LaTeX-only polish: use `paper_gptpro_bundle.zip` (Overleaf project + compiled `paper.pdf` snapshot + editing prompt).
- For a full artifact/provenance audit: use the Phase 8 release ZIP produced in a fresh workspace via the runbook pipeline (not any stale pack ZIPs sitting in the repo root).
